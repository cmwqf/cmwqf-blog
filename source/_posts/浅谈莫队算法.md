---
title: 浅谈莫队算法
date: 2021-07-20 19:43:06
tags: [莫队]
categories: [学习笔记]
---

# 普通莫队

莫队，是一种算法，是国家队长莫涛发明的，它是来解决什么问题的呢？

我们常常会遇到这样一类题：给你一个$$[1,n]$$的序列，每次查询$$[l,r]$$的一些信息（例如不同数的个数等），这个时候，我们就可以使用莫队来解决。

<!--more-->

注意，莫队是一种离线算法。

我们考虑，当我们知道$$[l1,r1]$$的值时，我们要计算出$$[l2,r2]$$的值。

我们可以$$O(1)$$地算出$$[l1-1,r1],[l1+1,r1],[l1,r1-1],[l1,r1+1]$$的值，那么，我们就可以在$$O(|l2-l1|+|r2-r1|)$$的时间复杂度内完成这次转移，即算出答案。也就是说，我们可以省去这两个询问区间的交集所需要的时间。

而我们现在要做的，就是通过一种特定的排序方式，使得对于一个询问集合$$q$$,使得$$\sum_{i=1}^n(|q[i].l-q[i-1].l|+q[i].r-q[i-1].r|)$$达到我们可以接受的值；

我们考虑用分块来优化，以**左端点所在的块**为第一关键字，**右端点的值**为第二关键字来排序，这样的时间复杂度就降到了$$O(n\sqrt{m})$$。

为什么呢？

设块大小为$$B$$。

我们考虑莫队的过程，左端点在同一个块里的操作会在一起做。我们考虑$$l,r$$指针的移动次数。先考虑块内移动，对于每个询问，左端点因为在块内移动，最多移动$$B$$次，而右端点由于对于每个块内部右端点是单调的（可能单调升也可能单调降），因此对于每个块内的所有询问，右端点的移动次数和是$$O(n)$$的。那么总复杂度就是$$O(mB+\frac{n^2}{B})$$，此时当$$mB=\frac{n^2}{B}$$，即$$B=\frac{n}{\sqrt{m}}$$时，复杂度达到理论最优，为$$O(n\sqrt{m})$$。

另外，我们在comp函数中可以进行优化（奇偶块优化），即如果是奇数块就右端点升序排列，否则就降序排列：

```C++
inline bool comp(Node a, Node b)
{
	return belong[a.l] ^ belong[b.l] ? belong[a.l] < belong[b.l] : belong[a.l] & 1 ? a.r < b.r : a.r > b.r; 
}
```

这样会快很多，还有就是$$B$$的大小跟代码速度有巨大关系，实际上当$$B=\frac{n}{\sqrt{\frac{2}{3}m}}$$时，是最快的

# 高维莫队

从本质上来看，莫队是解决偏序问题的有力武器，具体来说，对于每个点，它有若干维度，那么莫队的每个询问就是查询第一个维度$$\le a_1$$，第二个维度$$\le a_2$$，...，第$$k$$个维度$$\le a_k$$的点的集合的价值（当然，每一维也可以是$$\ge $$）。

而普通莫队，本质上是二维莫队，即它的询问形如求第一维$$\ge l$$，第二维$$\le r$$的点构成的集合的价值，而在序列上点的第一维和第二维都是这个点的位置。

为了方便起见，在以下的讨论中，我们默认对于每一维的限制都是$$\le a_i$$，并且假设是$$k$$维莫队。

那么，莫队实际上是维护了$$k$$个指针$$(t_1,t_2,\dots,t_k)$$，而每次操作形如$$add(t_i)$$或者$$del(t_i)$$，其意义在于加入/删除第$$i$$维为$$t_i$$，且对于剩下的第$$j$$（$$j\neq i$$）维均满足$$a_j\le t_j$$的点。而为什么在普通莫队中我们看不到这样的操作呢？那是由于序列操作的特殊性，使得我们无需判断这些情况。

那么，对于高维莫队，我们怎么解决呢？

以下为了方便起见，我们假设每一维的值域都是相同的$$[1, n]$$，且询问数和值域同阶，也是$$n$$。

仍然沿用二维莫队的做法，我们给前$$k-1$$维进行分块。设每一维都以$$B$$个值为一块。那么在给询问排序的时候，我们先比较第一维块的编号，若相同则比较第二维块的编号，...，若前$$k-1$$维编号都相同，那么就比较第$$k$$维的大小。

那么，这样做的复杂度是什么呢？

首先，考虑第$$k$$维指针的移动次数。一共有$$(\frac{n}{B})^{k-1}$$种不同的块，而每个块我们都要在第$$k$$维遍历一遍，因此这一部分的复杂度是$$(\frac{n}{B})^{k-1}n$$，即$$\frac{n^k}{B^{k-1}}$$。

然后，考虑前$$k-1$$维指针移动的次数。对于每个询问，前$$k-1$$个指针每个指针都最多移动$$B$$次，因此这一部分复杂度为$$knB$$。由于$$k$$不会很大，基本上是常数，因此我们把这一部分复杂度看成$$nB$$。

总复杂度即$$\frac{n^k}{B^{k-1}}+nB$$，那么在$$B=n^{\frac{k-1}{k}}$$时这个式子取到最小，是$$O(n^{\frac{2k-1}{k}})$$。

那么，对于高维莫队，我们有了统一的解决方法，可以发现当$$k$$过大的时候这个方法不一定有暴力优秀，因此对于这类问题，$$k$$不会很大。

# 应用

其实很多问题可以看成高维莫队问题。

例如，我们常说的带修莫队，实际上就是三维莫队，即我们多加了一维时间，表示求所有时间$$\le t$$的点的价值，此时我们取$$B=n^{\frac{2}{3}}$$最优，复杂度为$$O(n^{\frac{5}{3}})$$。

而对于一类对矩形进行统计的问题，我们可以把它看成四维莫队，即行有两维限制，列也有两维限制，那么我们只需要快速求出同一行某个区间内的价值及同一列某个区间内价值即可，此时取$$B=n^{\frac{3}{4}}$$，时间复杂度$$O(n^{\frac{7}{4}})$$。

