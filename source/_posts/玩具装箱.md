---
title: 玩具装箱
date: 2019-07-23 15:48:52
tags: [dp,斜率优化dp]
categories: [BZOJ]
---

# Description

把一个长度为n($1<=n<=50000$)的序列分为若干段，每段[i~j]的费用是
$$
(j-i-L+\sum_{k=i}^jC[k])^2
$$
求最小费用是多少？

<!--more-->


# 一般的方法

对于一个式子
$$
f[i]=f[j]+...
$$
我们把这个式子分组，写成$f[i]=a[i]*b[j]+c[j]+$（一个只与i有关的常数）。

$a[i]$表示一个只与$i$有关的数。

然后，我们移项，写成$-a[i]*b[j]+f[i]=c[j]$。

这就是一个$y=kx+b$的形式啦。

这样，我们把$-a[i]$看成斜率$k$，$f[i]$看成截距$b$，那么问题就转化为，我们已知这条直线的斜率为$k$，还有很多个点$(b[j],c[j])$，我们要找出一个点，它构成的直线截距最小。

然后就可以用单调队列了。

# Sol

首先，很显然，我们能想出一个暴力dp
$$
f[i]=min(f[i],f[j]+(i-j-1+sum[i]-sum[j]-L)^2)
$$
但这是一个$O(n^2)$的，显然不符合条件。

可以看到，后面的通过组合可以形成关于$i,j$的一个相同形式：$i+sum[i]$和$j+sum[j]$。于是，我们计$s[i]=i+sum[i]$，再把$L++$，则原式可以写成
$$
f[i]=f[j]+(s[i]-s[j]-L)^2\\
f[i]=f[j]+s[i]^2+s[j]^2+L^2-2*s[i]*s[j]-2*s[i]*L+2*s[j]*L
$$

我们考虑刚刚所说的方法：
$$
2*s[i]*s[j]+f[i]=f[j]+s[j]^2+2*s[j]*L+(s[i]-L)^2
$$
因为后面那个$(s[i]-L)^2$是个常数，我们暂且不管它，最后加上就好了。

那么，对于每一个$j$，都是一个固定的点$(s[j],f[j]+s[j]^2+2\*s[j]\*L)$。

这样，$2*s[i]$就是斜率$k$了。

我们可以发现，随着$i$的增长，$k$也是递增的且恒大于0。

我们考虑对于横坐标递增的两个点$A(x1,y1)$和$B(x2,y2)$，必然有$x1<=x2&&y1<=y2$。

如果$B$比$A$更优的话，当且仅当
$$
y2-k*x2<y1-k*x1\\
y2-y1<k*(x2-x1)\\
\frac{y2-y1}{x2-x1}<k
$$
也就是说，如果这两个点所构成的直线的斜率小于$k$，那么$A$点就可以直接舍弃了，因为后面的$k$递增，永远都不可能用到$A$点了。

这样，我们可以确定单调队列里是按照斜率从小到大来排列的。

我们考虑新加入一个点，从对尾开始不断比较，如果它的斜率小于对尾的斜率，就不断弹出来，就好了。

复杂度$O(n)$。

# Code














