---
title: 浅谈卢卡斯定理及扩展
date: 2020-04-26 20:40:47
tags: [数论]
categories: [学习笔记]
---

# 卢卡斯定理

卢卡斯定理是用来快速计算组合数的。在一些题目中，我们要求$\binom{n}{m}\quad mod\quad P$，但是$n,m$很大，$P$却很小（$P\le 10^5$），那么卢卡斯定理就是用来加速这个过程的。

普通的卢卡斯定理要求$P$为质数，而扩展卢卡斯中$P$可以是合数。

卢卡斯定理十分简洁：
$$
\binom{n}{m}\quad mod\quad P=\binom{\lfloor\frac{n}{P}\rfloor}{\lfloor\frac{m}{P}\rfloor}*\binom{n\quad mod\quad P}{m\quad mod\quad P}\quad mod\quad P
$$
<!--more-->

# 扩展卢卡斯

实际上，扩展卢卡斯与卢卡斯定理似乎并无太大关联，只需掌握中国剩余定理与$exgcd$即可学习扩展卢卡斯定理。

如果$P$是合数，考虑设$P=p_1^{a_1}p_2^{a_2}...$，那么如果我们对于每个$i$，求出$\binom{n}{m}\equiv a_i\quad(mod\quad p_i^{a_i})$，就可以用中国剩余定理来进行合并。

那么，问题就转变为了如何求$\binom{n}{m}\quad mod\quad p^x$。

考虑$\binom{n}{m}=\frac{n!}{m!(n-m)!}$，我们只需求出$n!\quad mod\quad p^x$即可。

我们把所有$p$的倍数全部提取出来，那么就有
$$
n!=1*2*3...*n\\
=1*2*...*(p-1)*(p+1)*...*(2p-1)*(2p+1)...*(p*2p*3p*...)\\
=1*2*...*(p-1)*(p+1)...*p^t*t!
$$
其中$t= \lfloor\frac{n}{p}\rfloor$，那么我们发现实际上我们成功转化为了一个类似卢卡斯定理的子问题。

为了加快速度，我们可以把$\binom{n}{m}$中$p$的次数预处理出来，那么每次递归子问题的时候就不需要管分出来的$p$的次数了。

后面部分交给递归，现在我们观察前面的部分模$p^x$是循环的（当然还会有一些余项），那么我们可以计算出前面$p^x$以内的结果然后$\lfloor\frac{n}{p}\rfloor$次方一下，然后再暴力计算一下剩下的余项即可。

那么，对于每个$p^x$，时间复杂度为$O(p^xlog_pn)$。

所以整个算法的时间复杂度为$O(\sum p_i^{a_i}log_pn)$，所以当$\forall i,p_i\le 10^5$时可以使用扩展卢卡斯定理。

注意求逆元的时候，因为模数不是质数，所以应该用$exgcd$求逆元而不能用费马小定理。

知道了原理，代码自然也不难写出了，这里就不放代码了。