---
title: 浅谈询问分块
date: 2020-04-20 11:48:25
tags: [分块]
categories: [学习笔记]
---

# 询问分块

什么是询问分块？

对于一些题目，它的操作我们无法用高级数据结构在$$log_2n$$时间复杂度内解决，那么，我们可以考虑，**对询问分块，定期重构**，使复杂度降为$$\sqrt{n}$$级别。

注意，这个询问分块的适用范围还是比较广泛的，因为它只需要答案重构复杂度为$$O(n)$$，且对于一个修改，我们能很快，如在$$O(1)$$或$$O(log_2n)$$的时间内，计算出它对某个询问的贡献，那么我们就可以用这种对询问分块的方法。

实际上，对询问分块可以看成一种强大的暴力。

<!--more-->

# 原理

我们考虑两种暴力：

第一种，对于一个修改，我们用它暴力更新所有答案（例如单点加，区间查询，我们每加一个数，就修改所有前缀和）；第二种，对于一个询问，我们暴力枚举前面所有的修改，计算其对当前询问的影响。

这两种暴力，时间复杂度都是$$O(1)-O(n)$$的，只不过第一种是询问$$O(1)$$，修改$$O(n)$$，第二种为询问$$O(n)$$，修改$$O(1)$$。那么，我们能不能把这两种暴力结合起来呢？

实际上，对操作分块，定期重构，就是这两种暴力的结合。

# 流程

我们将所有的操作（查询和修改）分块，然后对于一个块的修改，我们暴力更新这个块内的所有询问（或者，对于一个块的询问，我们暴力遍历这个块的所有修改，计算贡献）。当这一个块结束的时候，我们用这个块内所有修改，重构所有的答案。

这就是整个流程，是不是非常简单？

时间复杂度呢？我们考虑设$$B$$个元素为一个块。

那么，对于第一种操作，每个修改会更新$$B$$个询问（或者每个询问会访问$$B$$个修改），这一部分时间复杂度为$$O(nB)$$；对于第二种操作，每次重构答案是$$O(n)$$，所以第二种操作复杂度为$$O(n\frac{n}{B})$$。

那么总复杂度为$$O(nB+n\frac{n}{B})$$，由均值不等式得当$$B=\sqrt{n}$$时时间复杂度为$$O(n\sqrt{n})$$。

# 应用

对于许多一般性问题，可以直接应用此思想。

对于有些树上问题，每次修改对询问的影响涉及所有点的更新，我们可以对整棵树在这个块内涉及的修改点建成一棵虚树，每次修改在虚树上面跑，也可以保证复杂度。

如果读者实在想不出有什么问题要建虚树，请看这道经典**虚树加操作分块**的题：

[CF966E May Holidays](https://codeforces.com/contest/966/problem/E)

